<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>🧪 Pruebas de Login - Estructura de Dominios</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #2c3e50;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
      }
      h2 {
        color: #34495e;
        margin-top: 30px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #fafafa;
      }
      .login-form {
        display: inline-block;
        margin: 10px;
        padding: 15px;
        border: 1px solid #bdc3c7;
        border-radius: 5px;
        background: white;
        min-width: 300px;
      }
      .form-group {
        margin: 10px 0;
      }
      label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
        color: #2c3e50;
      }
      input[type="email"],
      input[type="password"],
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      button {
        background-color: #3498db;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background-color: #2980b9;
      }
      .result {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        font-weight: bold;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .credential-table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
      }
      .credential-table th,
      .credential-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      .credential-table th {
        background-color: #f2f2f2;
        font-weight: bold;
      }
      .status-ok {
        color: #27ae60;
        font-weight: bold;
      }
      .status-error {
        color: #e74c3c;
        font-weight: bold;
      }
      .tenant-info {
        background: #e8f4fd;
        padding: 10px;
        border-left: 4px solid #3498db;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🧪 Pruebas de Login - Estructura de Dominios</h1>

      <div class="tenant-info">
        <strong>🌐 Detección de Tenant Actual:</strong>
        <div id="tenantInfo">Cargando...</div>
      </div>

      <h2>👑 Login Superadmin Global</h2>
      <div class="test-section">
        <div class="login-form">
          <h3>Superadmin (Acceso Global)</h3>
          <div class="form-group">
            <label for="superEmail">Email:</label>
            <input type="email" id="superEmail" value="superadmin@packfy.com" />
          </div>
          <div class="form-group">
            <label for="superPassword">Password:</label>
            <input
              type="password"
              id="superPassword"
              placeholder="Password existente"
            />
          </div>
          <button onclick="testLogin('super')">🔐 Probar Login</button>
          <div id="superResult" class="result" style="display: none"></div>
        </div>
      </div>

      <h2>🏢 Login Admins por Empresa</h2>
      <div class="test-section">
        <div class="login-form">
          <h3>Cuba Express Cargo</h3>
          <div class="form-group">
            <label>Email:</label>
            <input
              type="email"
              id="cubaEmail"
              value="admin@cubaexpress.com"
              readonly
            />
          </div>
          <div class="form-group">
            <label>Password:</label>
            <input type="password" id="cubaPassword" value="admin123" />
          </div>
          <button onclick="testLogin('cuba')">🔐 Probar Login</button>
          <div id="cubaResult" class="result" style="display: none"></div>
        </div>

        <div class="login-form">
          <h3>Habana Premium Logistics</h3>
          <div class="form-group">
            <label>Email:</label>
            <input
              type="email"
              id="habanaEmail"
              value="admin@habanapremium.com"
              readonly
            />
          </div>
          <div class="form-group">
            <label>Password:</label>
            <input type="password" id="habanaPassword" value="admin123" />
          </div>
          <button onclick="testLogin('habana')">🔐 Probar Login</button>
          <div id="habanaResult" class="result" style="display: none"></div>
        </div>

        <div class="login-form">
          <h3>Miami Shipping Express</h3>
          <div class="form-group">
            <label>Email:</label>
            <input
              type="email"
              id="miamiEmail"
              value="admin@miamishipping.com"
              readonly
            />
          </div>
          <div class="form-group">
            <label>Password:</label>
            <input type="password" id="miamiPassword" value="admin123" />
          </div>
          <button onclick="testLogin('miami')">🔐 Probar Login</button>
          <div id="miamiResult" class="result" style="display: none"></div>
        </div>

        <div class="login-form">
          <h3>Packfy Express</h3>
          <div class="form-group">
            <label>Email:</label>
            <input
              type="email"
              id="packfyEmail"
              value="admin@packfy.com"
              readonly
            />
          </div>
          <div class="form-group">
            <label>Password:</label>
            <input type="password" id="packfyPassword" value="admin123" />
          </div>
          <button onclick="testLogin('packfy')">🔐 Probar Login</button>
          <div id="packfyResult" class="result" style="display: none"></div>
        </div>
      </div>

      <h2>🔧 Prueba de Tenant personalizado</h2>
      <div class="test-section">
        <div class="login-form">
          <h3>Login con Tenant Específico</h3>
          <div class="form-group">
            <label for="customEmail">Email:</label>
            <input
              type="email"
              id="customEmail"
              placeholder="email@dominio.com"
            />
          </div>
          <div class="form-group">
            <label for="customPassword">Password:</label>
            <input type="password" id="customPassword" placeholder="password" />
          </div>
          <div class="form-group">
            <label for="customTenant">Tenant (Empresa):</label>
            <select id="customTenant">
              <option value="cuba-express">Cuba Express Cargo</option>
              <option value="habana-premium">Habana Premium Logistics</option>
              <option value="miami-shipping">Miami Shipping Express</option>
              <option value="packfy-express">Packfy Express</option>
            </select>
          </div>
          <button onclick="testLogin('custom')">🔐 Probar Login</button>
          <div id="customResult" class="result" style="display: none"></div>
        </div>
      </div>

      <h2>📊 Resumen de Credenciales</h2>
      <div class="test-section">
        <table class="credential-table">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Email</th>
              <th>Password</th>
              <th>Empresa</th>
              <th>Rol</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>👑 Super Admin</td>
              <td>superadmin@packfy.com</td>
              <td>[existente]</td>
              <td>Todas</td>
              <td>super_admin</td>
              <td><span id="superStatus">Verificando...</span></td>
            </tr>
            <tr>
              <td>🏢 Admin Empresa</td>
              <td>admin@cubaexpress.com</td>
              <td>admin123</td>
              <td>Cuba Express Cargo</td>
              <td>admin_empresa</td>
              <td><span id="cubaStatus">Verificando...</span></td>
            </tr>
            <tr>
              <td>🏢 Admin Empresa</td>
              <td>admin@habanapremium.com</td>
              <td>admin123</td>
              <td>Habana Premium</td>
              <td>admin_empresa</td>
              <td><span id="habanaStatus">Verificando...</span></td>
            </tr>
            <tr>
              <td>🏢 Admin Empresa</td>
              <td>admin@miamishipping.com</td>
              <td>admin123</td>
              <td>Miami Shipping</td>
              <td>admin_empresa</td>
              <td><span id="miamiStatus">Verificando...</span></td>
            </tr>
            <tr>
              <td>🏢 Admin Empresa</td>
              <td>admin@packfy.com</td>
              <td>admin123</td>
              <td>Packfy Express</td>
              <td>admin_empresa</td>
              <td><span id="packfyStatus">Verificando...</span></td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2>🎯 Probar Todos los Logins</h2>
      <div class="test-section">
        <button
          onclick="testAllLogins()"
          style="background-color: #27ae60; font-size: 16px; padding: 15px 30px"
        >
          🚀 Probar Todos los Logins Automáticamente
        </button>
        <div
          id="allTestsResult"
          class="result"
          style="display: none; margin-top: 15px"
        ></div>
      </div>

      <h2>🔧 Debug & Logs</h2>
      <div class="test-section">
        <div
          style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap"
        >
          <button
            onclick="testBackendConnection()"
            style="background-color: #f39c12; padding: 10px 15px"
          >
            🔗 Probar Conexión Backend
          </button>
          <button
            onclick="clearLogs()"
            style="background-color: #95a5a6; padding: 10px 15px"
          >
            🗑️ Limpiar Logs
          </button>
          <button
            onclick="exportResults()"
            style="background-color: #8e44ad; padding: 10px 15px"
          >
            📸 Exportar Resultados
          </button>
          <button
            onclick="copyLogs()"
            style="background-color: #e67e22; padding: 10px 15px"
          >
            📋 Copiar Logs
          </button>
        </div>
        <div
          style="
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
          "
        >
          <div style="color: #f39c12; margin-bottom: 10px; font-weight: bold">
            📋 Debug Logs:
          </div>
          <pre id="debugLogs" style="margin: 0; white-space: pre-wrap">
Iniciando sistema de logs...</pre
          >
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:8000";

      // Logs para debugging
      const logs = [];
      function addLog(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const log = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
        logs.push(log);
        console.log(log);

        // Actualizar área de logs
        const logArea = document.getElementById("debugLogs");
        if (logArea) {
          logArea.innerHTML = logs.slice(-50).join("\n"); // Últimos 50 logs
          logArea.scrollTop = logArea.scrollHeight;
        }
      }

      // Detectar tenant actual
      function detectCurrentTenant() {
        const hostname = window.location.hostname;
        addLog(`Detectando tenant para hostname: ${hostname}`);

        const domainMap = {
          "cubaexpress.com": "cuba-express",
          "habanapremium.com": "habana-premium",
          "miamishipping.com": "miami-shipping",
          "packfy.com": "packfy-express",
        };

        let tenant = domainMap[hostname] || "packfy-express";

        if (hostname === "localhost" || hostname === "127.0.0.1") {
          tenant = "packfy-express";
          addLog(`Usando tenant por defecto para desarrollo: ${tenant}`);
        } else {
          addLog(`Tenant mapeado: ${hostname} → ${tenant}`);
        }

        document.getElementById("tenantInfo").innerHTML = `
                <strong>Dominio:</strong> ${hostname}<br>
                <strong>Tenant Detectado:</strong> ${tenant}<br>
                <strong>Header API:</strong> X-Tenant-Slug: ${tenant}
            `;

        return tenant;
      }

      // Función para probar login
      async function testLogin(type) {
        addLog(`=== INICIANDO PRUEBA DE LOGIN: ${type.toUpperCase()} ===`);

        let email, password, tenant;
        let resultId;

        switch (type) {
          case "super":
            email = document.getElementById("superEmail").value;
            password = document.getElementById("superPassword").value;
            tenant = "packfy-express"; // Default para superadmin
            resultId = "superResult";
            break;
          case "cuba":
            email = document.getElementById("cubaEmail").value;
            password = document.getElementById("cubaPassword").value;
            tenant = "cuba-express";
            resultId = "cubaResult";
            break;
          case "habana":
            email = document.getElementById("habanaEmail").value;
            password = document.getElementById("habanaPassword").value;
            tenant = "habana-premium";
            resultId = "habanaResult";
            break;
          case "miami":
            email = document.getElementById("miamiEmail").value;
            password = document.getElementById("miamiPassword").value;
            tenant = "miami-shipping";
            resultId = "miamiResult";
            break;
          case "packfy":
            email = document.getElementById("packfyEmail").value;
            password = document.getElementById("packfyPassword").value;
            tenant = "packfy-express";
            resultId = "packfyResult";
            break;
          case "custom":
            email = document.getElementById("customEmail").value;
            password = document.getElementById("customPassword").value;
            tenant = document.getElementById("customTenant").value;
            resultId = "customResult";
            break;
          default:
            addLog(`Tipo de test no reconocido: ${type}`, "error");
            return;
        }

        addLog(`Email: ${email}, Tenant: ${tenant}`);

        const resultDiv = document.getElementById(resultId);
        resultDiv.style.display = "block";
        resultDiv.className = "result info";
        resultDiv.innerHTML = "🔄 Probando login...";

        const apiUrl = `${API_BASE_URL}/api/auth/login/`;
        addLog(`URL de la API: ${apiUrl}`);

        const requestHeaders = {
          "Content-Type": "application/json",
          "X-Tenant-Slug": tenant,
        };
        addLog(`Headers: ${JSON.stringify(requestHeaders)}`);

        const requestBody = {
          email: email,
          password: password,
        };
        addLog(`Body: ${JSON.stringify({ email, password: "***" })}`);

        try {
          addLog(`Enviando petición a ${apiUrl}...`);

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: requestHeaders,
            body: JSON.stringify(requestBody),
          });

          addLog(
            `Respuesta recibida - Status: ${response.status} ${response.statusText}`
          );
          addLog(
            `Response headers: ${JSON.stringify(
              Object.fromEntries(response.headers)
            )}`
          );

          let data;
          const responseText = await response.text();
          addLog(`Respuesta texto: ${responseText}`);

          try {
            data = JSON.parse(responseText);
            addLog(`Respuesta JSON parseada correctamente`);
          } catch (parseError) {
            addLog(`Error parseando JSON: ${parseError.message}`, "error");
            throw new Error(`Respuesta no es JSON válido: ${responseText}`);
          }

          if (response.ok) {
            addLog(`Login exitoso para ${email}`, "success");
            resultDiv.className = "result success";
            resultDiv.innerHTML = `
                        ✅ <strong>Login Exitoso!</strong><br>
                        👤 Usuario: ${data.user?.email || email}<br>
                        🏢 Tenant: ${tenant}<br>
                        🔑 Token recibido: ${data.access ? "Sí" : "No"}<br>
                        📊 Empresas disponibles: ${
                          data.user?.companies?.length || "No especificado"
                        }
                    `;

            // Actualizar estado en tabla
            updateStatus(type, "OK");
          } else {
            addLog(
              `Login falló para ${email}: ${
                data.detail || data.error || response.statusText
              }`,
              "error"
            );
            resultDiv.className = "result error";
            resultDiv.innerHTML = `
                        ❌ <strong>Login Falló</strong><br>
                        📝 Error: ${
                          data.detail || data.error || "Error desconocido"
                        }<br>
                        🌐 Status HTTP: ${response.status} ${
              response.statusText
            }<br>
                        � Tenant usado: ${tenant}<br>
                        📧 Email: ${email}
                    `;

            // Actualizar estado en tabla
            updateStatus(type, "ERROR");
          }
        } catch (error) {
          addLog(`Error de conexión: ${error.message}`, "error");
          resultDiv.className = "result error";
          resultDiv.innerHTML = `
                    ❌ <strong>Error de Conexión</strong><br>
                    📝 ${error.message}<br>
                    🔗 Verificar que el backend esté corriendo en ${API_BASE_URL}<br>
                    🌐 URL completa: ${apiUrl}
                `;

          updateStatus(type, "CONN_ERROR");
        }

        addLog(`=== FIN PRUEBA DE LOGIN: ${type.toUpperCase()} ===`);
      }

      // Actualizar estado en tabla
      function updateStatus(type, status) {
        const statusMap = {
          super: "superStatus",
          cuba: "cubaStatus",
          habana: "habanaStatus",
          miami: "miamiStatus",
          packfy: "packfyStatus",
        };

        const statusId = statusMap[type];
        if (statusId) {
          const element = document.getElementById(statusId);
          if (status === "OK") {
            element.className = "status-ok";
            element.textContent = "✅ Login OK";
          } else {
            element.className = "status-error";
            element.textContent = "❌ Error";
          }
        }
      }

      // Probar todos los logins
      async function testAllLogins() {
        addLog(`=== INICIANDO PRUEBAS AUTOMÁTICAS ===`);
        const resultDiv = document.getElementById("allTestsResult");
        resultDiv.style.display = "block";
        resultDiv.className = "result info";
        resultDiv.innerHTML = "🚀 Ejecutando todas las pruebas de login...";

        const tests = ["cuba", "habana", "miami", "packfy"];
        const results = [];

        for (const test of tests) {
          try {
            addLog(`Ejecutando test: ${test}`);
            await testLogin(test);
            await new Promise((resolve) => setTimeout(resolve, 1500)); // Pausa entre pruebas
          } catch (error) {
            addLog(`Error en test ${test}: ${error.message}`, "error");
          }
        }

        resultDiv.className = "result success";
        resultDiv.innerHTML = `
                ✅ <strong>Pruebas Completadas</strong><br>
                📊 Revisa los resultados individuales arriba<br>
                📝 Verifica la tabla de estado para un resumen completo
            `;

        addLog(`=== PRUEBAS AUTOMÁTICAS COMPLETADAS ===`);
      }

      // Probar conexión con el backend
      async function testBackendConnection() {
        addLog(`=== PROBANDO CONEXIÓN BACKEND ===`);

        const endpoints = [
          `${API_BASE_URL}/api/`,
          `${API_BASE_URL}/api/health/`,
          `${API_BASE_URL}/admin/`,
        ];

        for (const endpoint of endpoints) {
          try {
            addLog(`Probando endpoint: ${endpoint}`);
            const response = await fetch(endpoint, { method: "GET" });
            addLog(
              `${endpoint} → Status: ${response.status} ${response.statusText}`,
              response.ok ? "success" : "warning"
            );
          } catch (error) {
            addLog(`${endpoint} → Error: ${error.message}`, "error");
          }
        }

        // Probar CORS
        try {
          addLog(`Probando CORS con OPTIONS...`);
          const response = await fetch(`${API_BASE_URL}/api/auth/login/`, {
            method: "OPTIONS",
            headers: {
              Origin: window.location.origin,
              "Access-Control-Request-Method": "POST",
              "Access-Control-Request-Headers": "Content-Type, X-Tenant-Slug",
            },
          });
          addLog(
            `CORS test → Status: ${response.status}`,
            response.ok ? "success" : "warning"
          );
        } catch (error) {
          addLog(`CORS test → Error: ${error.message}`, "error");
        }

        addLog(`=== FIN PRUEBA CONEXIÓN ===`);
      }

      // Limpiar logs
      function clearLogs() {
        logs.length = 0;
        const logArea = document.getElementById("debugLogs");
        if (logArea) {
          logArea.innerHTML = "Logs limpiados...";
        }
        addLog(`Sistema de logs reiniciado`);
      }

      // Copiar logs al clipboard
      function copyLogs() {
        const logText = logs.join("\n");
        navigator.clipboard
          .writeText(logText)
          .then(() => {
            addLog(`Logs copiados al clipboard (${logs.length} entradas)`);
            alert("📋 Logs copiados al clipboard!");
          })
          .catch((error) => {
            addLog(`Error copiando logs: ${error.message}`, "error");
          });
      }

      // Exportar resultados como captura
      function exportResults() {
        addLog(`Exportando resultados...`);

        const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
        const results = {
          timestamp,
          url: window.location.href,
          userAgent: navigator.userAgent,
          api_base_url: API_BASE_URL,
          tenant_info: document.getElementById("tenantInfo").innerText,
          logs: logs.slice(),
          test_results: {},
        };

        // Capturar resultados de tests
        const statusElements = [
          "superStatus",
          "cubaStatus",
          "habanaStatus",
          "miamiStatus",
          "packfyStatus",
        ];
        statusElements.forEach((id) => {
          const element = document.getElementById(id);
          if (element) {
            results.test_results[id] = element.textContent;
          }
        });

        // Crear archivo para descargar
        const blob = new Blob([JSON.stringify(results, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `login-test-results-${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        addLog(
          `Resultados exportados como: login-test-results-${timestamp}.json`
        );
      }

      // Inicializar
      document.addEventListener("DOMContentLoaded", function () {
        addLog(`=== INICIANDO SISTEMA DE PRUEBAS ===`);
        addLog(`Timestamp: ${new Date().toISOString()}`);
        addLog(`User Agent: ${navigator.userAgent}`);
        addLog(`URL: ${window.location.href}`);
        addLog(`API Base URL: ${API_BASE_URL}`);

        detectCurrentTenant();

        addLog(`Sistema inicializado correctamente`);
        addLog(`=== LISTO PARA PRUEBAS ===`);
      });
    </script>
  </body>
</html>
